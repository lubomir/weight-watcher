<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weight Watcher</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/js/moment.min.js"></script>
</head>
<body>
    <div class="side-link side-right">
        <a href="/">
            <span class="glyphicon glyphicon-menu-right"></span>
        </a>
    </div>

    <div class="container">

        <div class="row">
            <div class="col-md-12">
                <h1>Dashboard</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <h4>Trend in last week</h4>
                    <span class="card-detail" id="trend-w">?</span> kg
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <h4>Trend in last month</h4>
                    <span class="card-detail" id="trend-m">?</span> kg
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <h4>Trend in last 3 months</h4>
                    <span class="card-detail" id="trend-q">?</span> kg
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <h4>Height</h4>
                    <span class="card-detail" id="height">184</span> cm
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-center">
                    <h4>Weight</h4>
                    <span class="card-detail" id="weight">?</span> kg
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-center">
                    <h4>BMI</h4>
                    <span class="card-detail" id="bmi">?</span>
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        function getDiff(idx, when, data, ident) {
            for (; idx >= 0; --idx) {
                if (moment(data[idx][0]).diff(when) < 0) {
                    var last = data[data.length - 1];
                    var diff = last[2] - data[idx][2];
                    var elem = $(ident).text(diff.toFixed(1));
                    if (diff > 0) {
                        elem.addClass("text-danger");
                    } else if (diff < 0) {
                        elem.addClass("text-success");
                    }
                    return idx;
                }
            }
        }
        $(document).ready(function () {
        $.get("/data.json").success(function(data) {
          var alpha = 0.1;
          var d = [];
          var avg = 0;
          for (var i = 0, len = data.length; i < len; i++) {
              if (i == 0) {
                avg = data[i]['weight'];
              } else {
                avg = alpha * data[i]['weight'] + (1 - alpha) * avg;
              }
              d.push([new Date(data[i]['date']), data[i]['weight'], avg])
          };

            var height = parseInt($("#height").text());
            var last = d[d.length - 1];
            var weight = last[2]
            $("#weight").text(weight.toFixed(1));
            var bmi = weight / ((height / 100) * (height / 100));
            $("#bmi").text(bmi.toFixed(1));
            if (bmi > 30) {
                $("#bmi").addClass("text-danger");
            } else if (bmi > 25) {
                $("#bmi").addClass("text-warning");
            }

            var lastDate = moment(last[0]);
            var weekAgo = moment(lastDate).subtract(7, 'days');
            var monthAgo = moment(lastDate).subtract(1, 'months');
            var quarterAgo = moment(lastDate).subtract(3, 'months');

            var i = d.length - 1;
            i = getDiff(i, weekAgo, d, "#trend-w");
            i = getDiff(i, monthAgo, d, "#trend-m");
            getDiff(i, quarterAgo, d, "#trend-q");
        });
        });
    </script>
</body>
</html>
